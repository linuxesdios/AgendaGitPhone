<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìä Hist√≥rico de Tareas</title>
<style>
* { box-sizing: border-box; }
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  background: linear-gradient(135deg, #a8e6cf 0%, #88d8a3 100%);
  padding: 20px;
  min-height: 100vh;
}
.container {
  max-width: 1200px;
  margin: 0 auto;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.15);
  padding: 25px;
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.3);
}
.header {
  text-align: center;
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 3px solid #4ecdc4;
}
.header h1 {
  color: #2d5a27;
  font-size: 32px;
  margin: 0;
  font-weight: 800;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}
.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}
.stat-card {
  background: rgba(255, 255, 255, 0.9);
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  border: 1px solid rgba(255, 255, 255, 0.2);
}
.stat-number {
  font-size: 36px;
  font-weight: bold;
  color: #4ecdc4;
  margin-bottom: 5px;
}
.stat-label {
  color: #2d5a27;
  font-weight: 600;
  font-size: 14px;
}
.filters {
  background: rgba(255, 255, 255, 0.9);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
  display: flex;
  gap: 15px;
  align-items: center;
  flex-wrap: wrap;
}
.filter-group {
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.filter-label {
  font-size: 12px;
  font-weight: 600;
  color: #2d5a27;
}
.filter-select, .filter-input {
  padding: 8px 12px;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  font-size: 14px;
  background: white;
  color: #2c3e50;
}
.filter-select:focus, .filter-input:focus {
  outline: none;
  border-color: #4ecdc4;
}
.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-primary {
  background: #4ecdc4;
  color: white;
}
.btn-primary:hover {
  background: #44a08d;
  transform: translateY(-1px);
}
.btn-secondary {
  background: #95a5a6;
  color: white;
}
.btn-secondary:hover {
  background: #7f8c8d;
  transform: translateY(-1px);
}
.timeline {
  position: relative;
  padding-left: 30px;
}
.timeline::before {
  content: '';
  position: absolute;
  left: 15px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: #4ecdc4;
}
.timeline-item {
  position: relative;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  border-left: 4px solid #4ecdc4;
}
.timeline-item::before {
  content: '';
  position: absolute;
  left: -22px;
  top: 25px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: #4ecdc4;
  border: 3px solid white;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.timeline-item.created {
  border-left-color: #2196f3;
}
.timeline-item.created::before {
  background: #2196f3;
}
.timeline-item.completed {
  border-left-color: #4caf50;
}
.timeline-item.completed::before {
  background: #4caf50;
}
.timeline-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 10px;
}
.timeline-type {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
}
.timeline-type.created {
  background: #e3f2fd;
  color: #1976d2;
}
.timeline-type.completed {
  background: #e8f5e8;
  color: #2e7d32;
}
.timeline-date {
  color: #666;
  font-size: 12px;
  font-weight: 500;
}
.timeline-content {
  color: #2c3e50;
  line-height: 1.5;
}
.timeline-title {
  font-weight: 600;
  margin-bottom: 5px;
}
.timeline-details {
  font-size: 14px;
  color: #666;
}
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #777;
}
.empty-state-icon {
  font-size: 64px;
  margin-bottom: 20px;
}
@media (max-width: 768px) {
  .container { padding: 15px; }
  .header h1 { font-size: 24px; }
  .stats { grid-template-columns: 1fr 1fr; }
  .filters { flex-direction: column; align-items: stretch; }
  .timeline { padding-left: 20px; }
  .timeline::before { left: 10px; }
  .timeline-item::before { left: -17px; }
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üìä Hist√≥rico de Tareas</h1>
  </div>

  <div class="stats" id="stats">
    <div class="stat-card">
      <div class="stat-number" id="stat-created">0</div>
      <div class="stat-label">Tareas Creadas</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="stat-completed">0</div>
      <div class="stat-label">Tareas Completadas</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="stat-today">0</div>
      <div class="stat-label">Actividad Hoy</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="stat-week">0</div>
      <div class="stat-label">Esta Semana</div>
    </div>
  </div>

  <div class="filters">
    <div class="filter-group">
      <label class="filter-label">Tipo</label>
      <select id="filter-type" class="filter-select">
        <option value="">Todos</option>
        <option value="created">Creadas</option>
        <option value="completed">Completadas</option>
      </select>
    </div>
    <div class="filter-group">
      <label class="filter-label">Desde</label>
      <input type="date" id="filter-from" class="filter-input">
    </div>
    <div class="filter-group">
      <label class="filter-label">Hasta</label>
      <input type="date" id="filter-to" class="filter-input">
    </div>
    <button class="btn btn-primary" onclick="aplicarFiltros()">Filtrar</button>
    <button class="btn btn-secondary" onclick="limpiarFiltros()">Limpiar</button>
    <button class="btn btn-secondary" onclick="exportarHistorico()">Exportar</button>
  </div>

  <div class="timeline" id="timeline">
    <div class="empty-state">
      <div class="empty-state-icon">üìù</div>
      <h3>No hay registros</h3>
      <p>El hist√≥rico se ir√° llenando conforme uses la agenda</p>
    </div>
  </div>
</div>

<script>
let historico = [];
let historicoFiltrado = [];

// Cargar hist√≥rico desde GitHub
async function cargarHistorico() {
  try {
    const config = JSON.parse(localStorage.getItem('github-sync-config') || '{}');
    const token = sessionStorage.getItem('github-sync-token') || localStorage.getItem('github-sync-token');
    
    if (!config.repo || !token) {
      console.log('GitHub no configurado');
      return;
    }

    const [owner, repo] = config.repo.split('/');
    const historicoFile = config.historico || 'historico.json';
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${historicoFile}`;
    
    const response = await fetch(url, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    if (response.ok) {
      const data = await response.json();
      const content = atob(data.content.replace(/\n/g, ''));
      historico = JSON.parse(content);
    } else if (response.status === 404) {
      // Archivo no existe, crear uno vac√≠o
      historico = [];
      await guardarHistorico();
    }
  } catch (error) {
    console.error('Error cargando hist√≥rico:', error);
    historico = [];
  }
  
  actualizarVista();
}

// Guardar hist√≥rico en GitHub
async function guardarHistorico() {
  try {
    const config = JSON.parse(localStorage.getItem('github-sync-config') || '{}');
    const token = sessionStorage.getItem('github-sync-token') || localStorage.getItem('github-sync-token');
    
    if (!config.repo || !token) return;

    const [owner, repo] = config.repo.split('/');
    const historicoFile = config.historico || 'historico.json';
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${historicoFile}`;
    
    // Obtener SHA si existe
    let sha = null;
    try {
      const getResponse = await fetch(url, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      });
      if (getResponse.ok) {
        const data = await getResponse.json();
        sha = data.sha;
      }
    } catch (e) {}

    const content = btoa(JSON.stringify(historico, null, 2));
    const body = {
      message: 'Actualizar hist√≥rico de tareas',
      content: content,
      branch: config.branch || 'main'
    };
    
    if (sha) body.sha = sha;

    await fetch(url, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
  } catch (error) {
    console.error('Error guardando hist√≥rico:', error);
  }
}

// Registrar evento en el hist√≥rico
function registrarEvento(tipo, tarea, detalles = {}) {
  const evento = {
    id: Date.now().toString(),
    tipo: tipo, // 'created' o 'completed'
    fecha: new Date().toISOString(),
    tarea: {
      id: tarea.id,
      titulo: tarea.titulo || tarea.texto,
      tipo_tarea: tarea.titulo ? 'critica' : 'normal'
    },
    detalles: detalles
  };
  
  historico.unshift(evento); // Agregar al inicio
  guardarHistorico();
  actualizarVista();
}

// Actualizar estad√≠sticas y timeline
function actualizarVista() {
  actualizarEstadisticas();
  aplicarFiltros();
}

function actualizarEstadisticas() {
  const hoy = new Date().toISOString().slice(0, 10);
  const inicioSemana = new Date();
  inicioSemana.setDate(inicioSemana.getDate() - inicioSemana.getDay());
  const inicioSemanaStr = inicioSemana.toISOString().slice(0, 10);

  const creadas = historico.filter(h => h.tipo === 'created').length;
  const completadas = historico.filter(h => h.tipo === 'completed').length;
  const hoyCount = historico.filter(h => h.fecha.slice(0, 10) === hoy).length;
  const semanaCount = historico.filter(h => h.fecha.slice(0, 10) >= inicioSemanaStr).length;

  document.getElementById('stat-created').textContent = creadas;
  document.getElementById('stat-completed').textContent = completadas;
  document.getElementById('stat-today').textContent = hoyCount;
  document.getElementById('stat-week').textContent = semanaCount;
}

function aplicarFiltros() {
  const tipoFiltro = document.getElementById('filter-type').value;
  const desdeFiltro = document.getElementById('filter-from').value;
  const hastaFiltro = document.getElementById('filter-to').value;

  historicoFiltrado = historico.filter(evento => {
    if (tipoFiltro && evento.tipo !== tipoFiltro) return false;
    
    const fechaEvento = evento.fecha.slice(0, 10);
    if (desdeFiltro && fechaEvento < desdeFiltro) return false;
    if (hastaFiltro && fechaEvento > hastaFiltro) return false;
    
    return true;
  });

  renderTimeline();
}

function limpiarFiltros() {
  document.getElementById('filter-type').value = '';
  document.getElementById('filter-from').value = '';
  document.getElementById('filter-to').value = '';
  aplicarFiltros();
}

function renderTimeline() {
  const timeline = document.getElementById('timeline');
  
  if (historicoFiltrado.length === 0) {
    timeline.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üìù</div>
        <h3>No hay registros</h3>
        <p>El hist√≥rico se ir√° llenando conforme uses la agenda</p>
      </div>
    `;
    return;
  }

  let html = '';
  historicoFiltrado.forEach(evento => {
    const fecha = new Date(evento.fecha);
    const fechaFormateada = fecha.toLocaleDateString('es-ES', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });

    const icono = evento.tipo === 'created' ? '‚ûï' : '‚úÖ';
    const accion = evento.tipo === 'created' ? 'Creada' : 'Completada';
    const tipoTarea = evento.tarea.tipo_tarea === 'critica' ? 'üö® Cr√≠tica' : '‚úÖ Normal';

    html += `
      <div class="timeline-item ${evento.tipo}">
        <div class="timeline-header">
          <span class="timeline-type ${evento.tipo}">${icono} ${accion}</span>
          <span class="timeline-date">${fechaFormateada}</span>
        </div>
        <div class="timeline-content">
          <div class="timeline-title">${evento.tarea.titulo}</div>
          <div class="timeline-details">
            Tipo: ${tipoTarea}
            ${evento.detalles.duracion ? ` ‚Ä¢ Duraci√≥n: ${evento.detalles.duracion}` : ''}
          </div>
        </div>
      </div>
    `;
  });

  timeline.innerHTML = html;
}

function exportarHistorico() {
  const datos = {
    fecha_exportacion: new Date().toISOString(),
    total_eventos: historico.length,
    eventos: historico
  };
  
  const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `historico_tareas_${new Date().toISOString().slice(0, 10)}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Funciones para ser llamadas desde la agenda principal
window.registrarTareaCreada = function(tarea) {
  registrarEvento('created', tarea);
};

window.registrarTareaCompletada = function(tarea, fechaCreacion) {
  const duracion = fechaCreacion ? calcularDuracion(fechaCreacion, new Date()) : null;
  registrarEvento('completed', tarea, { duracion });
};

function calcularDuracion(inicio, fin) {
  const diff = fin - new Date(inicio);
  const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
  const horas = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  
  if (dias > 0) return `${dias} d√≠a${dias !== 1 ? 's' : ''}`;
  if (horas > 0) return `${horas} hora${horas !== 1 ? 's' : ''}`;
  return 'Menos de 1 hora';
}

// Inicializar
document.addEventListener('DOMContentLoaded', () => {
  cargarHistorico();
});
</script>

</body>
</html>