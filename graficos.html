<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìä Gr√°ficos de Productividad</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* { box-sizing: border-box; }
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  background: linear-gradient(135deg, #a8e6cf 0%, #88d8a3 100%);
  padding: 20px;
  min-height: 100vh;
}
.container {
  max-width: 1400px;
  margin: 0 auto;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.15);
  padding: 25px;
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.3);
}
.header {
  text-align: center;
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 3px solid #4ecdc4;
}
.header h1 {
  color: #2d5a27;
  font-size: 32px;
  margin: 0;
  font-weight: 800;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}
.charts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 25px;
  margin-bottom: 30px;
}
.chart-card {
  background: rgba(255, 255, 255, 0.9);
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  border: 1px solid rgba(255, 255, 255, 0.2);
}
.chart-title {
  color: #2d5a27;
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 15px;
  text-align: center;
}
.chart-container {
  position: relative;
  height: 300px;
}
.filters {
  background: rgba(255, 255, 255, 0.9);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
  display: flex;
  gap: 15px;
  align-items: center;
  flex-wrap: wrap;
}
.filter-group {
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.filter-label {
  font-size: 12px;
  font-weight: 600;
  color: #2d5a27;
}
.filter-select {
  padding: 8px 12px;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  font-size: 14px;
  background: white;
  color: #2c3e50;
}
.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-primary {
  background: #4ecdc4;
  color: white;
}
.btn-primary:hover {
  background: #44a08d;
  transform: translateY(-1px);
}
.stats-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-bottom: 25px;
}
.stat-item {
  background: rgba(255, 255, 255, 0.9);
  border-radius: 12px;
  padding: 15px;
  text-align: center;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
.stat-number {
  font-size: 24px;
  font-weight: bold;
  color: #4ecdc4;
  margin-bottom: 5px;
}
.stat-label {
  color: #2d5a27;
  font-size: 12px;
  font-weight: 600;
}
@media (max-width: 768px) {
  .container { padding: 15px; }
  .header h1 { font-size: 24px; }
  .charts-grid { grid-template-columns: 1fr; }
  .chart-container { height: 250px; }
  .filters { flex-direction: column; align-items: stretch; }
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üìä Gr√°ficos de Productividad</h1>
  </div>

  <div class="filters">
    <div class="filter-group">
      <label class="filter-label">Per√≠odo</label>
      <select id="filter-period" class="filter-select">
        <option value="7">√öltimos 7 d√≠as</option>
        <option value="30" selected>√öltimos 30 d√≠as</option>
        <option value="90">√öltimos 90 d√≠as</option>
      </select>
    </div>
    <button class="btn btn-primary" onclick="actualizarGraficos()">Actualizar</button>
  </div>

  <div class="stats-summary" id="stats-summary">
    <div class="stat-item">
      <div class="stat-number" id="total-creadas">0</div>
      <div class="stat-label">Tareas Creadas</div>
    </div>
    <div class="stat-item">
      <div class="stat-number" id="total-completadas">0</div>
      <div class="stat-label">Tareas Completadas</div>
    </div>
    <div class="stat-item">
      <div class="stat-number" id="total-citas">0</div>
      <div class="stat-label">Citas Programadas</div>
    </div>
    <div class="stat-item">
      <div class="stat-number" id="tasa-completado">0%</div>
      <div class="stat-label">Tasa de Completado</div>
    </div>
  </div>

  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-title">üìà Tareas por D√≠a</div>
      <div class="chart-container">
        <canvas id="chartTareasDiarias"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-title">üéØ Tipos de Tareas</div>
      <div class="chart-container">
        <canvas id="chartTiposTareas"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-title">üìÖ Citas por Semana</div>
      <div class="chart-container">
        <canvas id="chartCitasSemana"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-title">‚è±Ô∏è Productividad Semanal</div>
      <div class="chart-container">
        <canvas id="chartProductividad"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
let historico = [];
let agenda = {};
let charts = {};

// Cargar datos
async function cargarDatos() {
  try {
    const config = JSON.parse(localStorage.getItem('github-sync-config') || '{}');
    const token = sessionStorage.getItem('github-sync-token') || localStorage.getItem('github-sync-token');
    
    if (!config.repo || !token) {
      console.log('GitHub no configurado');
      return;
    }

    const [owner, repo] = config.repo.split('/');
    
    // Cargar hist√≥rico
    try {
      const historicoFile = config.historico || 'historico.json';
      const historicoUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${historicoFile}`;
      const historicoResponse = await fetch(historicoUrl, {
        headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github.v3+json' }
      });
      
      if (historicoResponse.ok) {
        const historicoData = await historicoResponse.json();
        const historicoContent = atob(historicoData.content.replace(/\n/g, ''));
        historico = JSON.parse(historicoContent);
      }
    } catch (e) {
      console.log('Error cargando hist√≥rico:', e);
    }

    // Cargar agenda actual
    try {
      const agendaFile = config.path || 'agenda.json';
      const agendaUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${agendaFile}`;
      const agendaResponse = await fetch(agendaUrl, {
        headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github.v3+json' }
      });
      
      if (agendaResponse.ok) {
        const agendaData = await agendaResponse.json();
        const agendaContent = atob(agendaData.content.replace(/\n/g, ''));
        agenda = JSON.parse(agendaContent);
      }
    } catch (e) {
      console.log('Error cargando agenda:', e);
    }

  } catch (error) {
    console.error('Error cargando datos:', error);
  }
  
  actualizarGraficos();
}

function actualizarGraficos() {
  const periodo = parseInt(document.getElementById('filter-period').value);
  const fechaLimite = new Date();
  fechaLimite.setDate(fechaLimite.getDate() - periodo);
  
  // Filtrar datos por per√≠odo
  const historicoFiltrado = historico.filter(h => new Date(h.fecha) >= fechaLimite);
  
  actualizarEstadisticas(historicoFiltrado);
  crearGraficoTareasDiarias(historicoFiltrado, periodo);
  crearGraficoTiposTareas(historicoFiltrado);
  crearGraficoCitasSemana(periodo);
  crearGraficoProductividad(historicoFiltrado, periodo);
}

function actualizarEstadisticas(historicoFiltrado) {
  const creadas = historicoFiltrado.filter(h => h.tipo === 'created').length;
  const completadas = historicoFiltrado.filter(h => h.tipo === 'completed').length;
  const citas = agenda.citas ? agenda.citas.length : 0;
  const tasa = creadas > 0 ? Math.round((completadas / creadas) * 100) : 0;

  document.getElementById('total-creadas').textContent = creadas;
  document.getElementById('total-completadas').textContent = completadas;
  document.getElementById('total-citas').textContent = citas;
  document.getElementById('tasa-completado').textContent = tasa + '%';
}

function crearGraficoTareasDiarias(historicoFiltrado, periodo) {
  const ctx = document.getElementById('chartTareasDiarias').getContext('2d');
  
  // Generar etiquetas de d√≠as
  const labels = [];
  const dataCreadas = [];
  const dataCompletadas = [];
  
  for (let i = periodo - 1; i >= 0; i--) {
    const fecha = new Date();
    fecha.setDate(fecha.getDate() - i);
    const fechaStr = fecha.toISOString().slice(0, 10);
    
    labels.push(fecha.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' }));
    
    const creadasDia = historicoFiltrado.filter(h => 
      h.tipo === 'created' && h.fecha.slice(0, 10) === fechaStr
    ).length;
    
    const completadasDia = historicoFiltrado.filter(h => 
      h.tipo === 'completed' && h.fecha.slice(0, 10) === fechaStr
    ).length;
    
    dataCreadas.push(creadasDia);
    dataCompletadas.push(completadasDia);
  }

  if (charts.tareasDiarias) charts.tareasDiarias.destroy();
  
  charts.tareasDiarias = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Creadas',
        data: dataCreadas,
        borderColor: '#2196f3',
        backgroundColor: 'rgba(33, 150, 243, 0.1)',
        tension: 0.4
      }, {
        label: 'Completadas',
        data: dataCompletadas,
        borderColor: '#4caf50',
        backgroundColor: 'rgba(76, 175, 80, 0.1)',
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

function crearGraficoTiposTareas(historicoFiltrado) {
  const ctx = document.getElementById('chartTiposTareas').getContext('2d');
  
  const criticas = historicoFiltrado.filter(h => 
    h.tarea && h.tarea.tipo_tarea === 'critica'
  ).length;
  
  const normales = historicoFiltrado.filter(h => 
    h.tarea && h.tarea.tipo_tarea === 'normal'
  ).length;

  if (charts.tiposTareas) charts.tiposTareas.destroy();
  
  charts.tiposTareas = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Cr√≠ticas', 'Normales'],
      datasets: [{
        data: [criticas, normales],
        backgroundColor: ['#f44336', '#4ecdc4'],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });
}

function crearGraficoCitasSemana(periodo) {
  const ctx = document.getElementById('chartCitasSemana').getContext('2d');
  
  if (!agenda.citas) {
    agenda.citas = [];
  }
  
  const semanas = Math.ceil(periodo / 7);
  const labels = [];
  const data = [];
  
  for (let i = semanas - 1; i >= 0; i--) {
    const inicioSemana = new Date();
    inicioSemana.setDate(inicioSemana.getDate() - (i * 7) - inicioSemana.getDay());
    const finSemana = new Date(inicioSemana);
    finSemana.setDate(finSemana.getDate() + 6);
    
    labels.push(`${inicioSemana.getDate()}/${inicioSemana.getMonth() + 1}`);
    
    const citasSemana = agenda.citas.filter(cita => {
      const fechaCita = new Date(cita.fecha);
      return fechaCita >= inicioSemana && fechaCita <= finSemana;
    }).length;
    
    data.push(citasSemana);
  }

  if (charts.citasSemana) charts.citasSemana.destroy();
  
  charts.citasSemana = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Citas',
        data: data,
        backgroundColor: '#9c27b0',
        borderColor: '#7b1fa2',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

function crearGraficoProductividad(historicoFiltrado, periodo) {
  const ctx = document.getElementById('chartProductividad').getContext('2d');
  
  const semanas = Math.ceil(periodo / 7);
  const labels = [];
  const dataProductividad = [];
  
  for (let i = semanas - 1; i >= 0; i--) {
    const inicioSemana = new Date();
    inicioSemana.setDate(inicioSemana.getDate() - (i * 7) - inicioSemana.getDay());
    const finSemana = new Date(inicioSemana);
    finSemana.setDate(finSemana.getDate() + 6);
    
    labels.push(`Sem ${semanas - i}`);
    
    const creadasSemana = historicoFiltrado.filter(h => {
      const fechaEvento = new Date(h.fecha);
      return h.tipo === 'created' && fechaEvento >= inicioSemana && fechaEvento <= finSemana;
    }).length;
    
    const completadasSemana = historicoFiltrado.filter(h => {
      const fechaEvento = new Date(h.fecha);
      return h.tipo === 'completed' && fechaEvento >= inicioSemana && fechaEvento <= finSemana;
    }).length;
    
    const productividad = creadasSemana > 0 ? (completadasSemana / creadasSemana) * 100 : 0;
    dataProductividad.push(Math.round(productividad));
  }

  if (charts.productividad) charts.productividad.destroy();
  
  charts.productividad = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Productividad (%)',
        data: dataProductividad,
        backgroundColor: '#ff9800',
        borderColor: '#f57c00',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { 
          beginAtZero: true,
          max: 100,
          ticks: {
            callback: function(value) {
              return value + '%';
            }
          }
        }
      }
    }
  });
}

// Inicializar
document.addEventListener('DOMContentLoaded', () => {
  cargarDatos();
});
</script>

</body>
</html>